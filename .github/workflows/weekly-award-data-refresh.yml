name: Weekly SBIR Awards Refresh

on:
  schedule:
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      force_refresh:
        description: "Force refresh even if CSV hash did not change"
        required: false
        default: false
        type: boolean
      source_url:
        description: "Override source URL (defaults to sbir.gov canonical feed)"
        required: false
        default: ""
        type: string

permissions:
  id-token: write  # For OIDC authentication to AWS
  contents: read   # Only read access needed (no Git operations)

concurrency:
  group: awards-data-refresh
  cancel-in-progress: false

env:
  DEFAULT_SOURCE_URL: https://data.www.sbir.gov/mod_awarddatapublic/award_data.csv

jobs:
  refresh-awards-data:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Lambda invocation is quick
    env:
      AWS_REGION: us-east-1
      LAMBDA_FUNCTION_NAME: sbir-weekly-refresh
      S3_BUCKET: sbir-etl-production-data
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Invoke Lambda function
        id: invoke_lambda
        run: |
          PAYLOAD=$(jq -n \
            --arg force_refresh "${{ github.event.inputs.force_refresh || 'false' }}" \
            --arg source_url "${{ github.event.inputs.source_url || '' }}" \
            --arg s3_bucket "${{ env.S3_BUCKET }}" \
            --arg neo4j_secret_name "${{ secrets.NEO4J_SECRET_NAME || '' }}" \
            '{
              force_refresh: ($force_refresh == "true"),
              source_url: (if $source_url == "" then null else $source_url end),
              s3_bucket: $s3_bucket,
              neo4j_secret_name: (if $neo4j_secret_name == "" then null else $neo4j_secret_name end)
            }')
          
          RESPONSE=$(aws lambda invoke \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --payload "$PAYLOAD" \
            --cli-binary-format raw-in-base64-out \
            /tmp/lambda-response.json)
          
          cat /tmp/lambda-response.json
          
          # Check if Lambda execution succeeded
          if echo "$RESPONSE" | jq -e '.FunctionError' > /dev/null; then
            echo "Lambda execution failed"
            exit 1
          fi
          
          RESULT=$(cat /tmp/lambda-response.json | jq -r '.body' | jq '.')
          echo "result=$RESULT" >> $GITHUB_OUTPUT
          
          STATUS=$(echo "$RESULT" | jq -r '.status')
          if [ "$STATUS" != "success" ] && [ "$STATUS" != "skipped" ]; then
            echo "Lambda returned status: $STATUS"
            exit 1
          fi

      - name: Display result
        run: |
          echo "Lambda execution completed"
          echo "Result: ${{ steps.invoke_lambda.outputs.result }}"
