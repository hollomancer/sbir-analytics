name: Weekly SBIR Awards Refresh (DEPRECATED - Use data-refresh.yml)

# ⚠️ DEPRECATION NOTICE:
# This workflow has been consolidated into data-refresh.yml
# Use the new unified workflow for all data refresh operations.
# This file is kept temporarily for reference and will be removed in a future release.

on:
  schedule:
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      force_refresh:
        description: "Force refresh even if CSV hash did not change"
        required: false
        default: false
        type: boolean
      source_url:
        description: "Override source URL (defaults to sbir.gov canonical feed)"
        required: false
        default: ""
        type: string

permissions:
  id-token: write  # For OIDC authentication to AWS
  contents: read   # Only read access needed (no Git operations)

concurrency:
  group: awards-data-refresh
  cancel-in-progress: false

env:
  AWS_REGION: us-east-2
  STEP_FUNCTIONS_STATE_MACHINE_ARN: ${{ secrets.STEP_FUNCTIONS_STATE_MACHINE_ARN }}
  S3_BUCKET: sbir-etl-production-data

jobs:
  invoke-step-functions:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Step Functions invocation is quick
    steps:
      - name: Configure AWS credentials
        uses: ./.github/actions/setup-aws-credentials
        with:
          role-arn: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Start Step Functions execution
        id: sf_execution
        run: |
          INPUT_PAYLOAD=$(jq -n \
            --arg force_refresh "${{ github.event.inputs.force_refresh || 'false' }}" \
            --arg source_url "${{ github.event.inputs.source_url || '' }}" \
            --arg s3_bucket "${{ env.S3_BUCKET }}" \
            '{
              force_refresh: ($force_refresh == "true"),
              source_url: (if $source_url == "" then null else $source_url end),
              s3_bucket: $s3_bucket
            }')

          EXECUTION_ARN=$(aws stepfunctions start-execution \
            --state-machine-arn "${{ env.STEP_FUNCTIONS_STATE_MACHINE_ARN }}" \
            --input "$INPUT_PAYLOAD" \
            --query 'executionArn' \
            --output text)

          echo "execution_arn=$EXECUTION_ARN" >> $GITHUB_OUTPUT
          echo "Started Step Functions execution: $EXECUTION_ARN"

      - name: Wait for completion (optional)
        run: |
          EXECUTION_ARN="${{ steps.sf_execution.outputs.execution_arn }}"
          echo "Step Functions execution started: $EXECUTION_ARN"
          echo "Monitor execution at: https://console.aws.amazon.com/states/home?region=${{ env.AWS_REGION }}#/executions/details/$EXECUTION_ARN"
          echo ""
          echo "Note: Step Functions will continue running asynchronously."
          echo "Check CloudWatch Logs or AWS Console for execution status."

      - name: Display execution info
        run: |
          echo "## Step Functions Execution"
          echo ""
          echo "**Execution ARN:** ${{ steps.sf_execution.outputs.execution_arn }}"
          echo ""
          echo "**AWS Console:** https://console.aws.amazon.com/states/home?region=${{ env.AWS_REGION }}#/executions/details/${{ steps.sf_execution.outputs.execution_arn }}"
          echo ""
          echo "The workflow will continue running in AWS Step Functions."
          echo "Check CloudWatch Logs for detailed execution logs."
