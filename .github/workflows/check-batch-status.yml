name: Check Batch Job Status

on:
  workflow_dispatch:
    inputs:
      job_id:
        description: 'Batch Job ID to check'
        required: true
        type: string
  schedule:
    - cron: '0 */2 * * *'  # Every 2 hours

permissions:
  id-token: write
  contents: read

jobs:
  check-status:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get latest USAspending job
        id: get-job
        run: |
          if [ -n "${{ inputs.job_id }}" ]; then
            JOB_ID="${{ inputs.job_id }}"
          else
            # Get most recent job for usaspending download
            JOB_ID=$(aws batch list-jobs \
              --job-queue sbir-analytics-job-queue \
              --job-status RUNNING \
              --query 'jobSummaryList[?jobName==`usaspending-download`] | [0].jobId' \
              --output text)

            if [ "$JOB_ID" = "None" ] || [ -z "$JOB_ID" ]; then
              JOB_ID=$(aws batch list-jobs \
                --job-queue sbir-analytics-job-queue \
                --job-status SUBMITTED \
                --query 'jobSummaryList[?jobName==`usaspending-download`] | [0].jobId' \
                --output text)
            fi
          fi

          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT

      - name: Check job status
        if: steps.get-job.outputs.job_id != 'None' && steps.get-job.outputs.job_id != ''
        run: |
          JOB_ID="${{ steps.get-job.outputs.job_id }}"

          STATUS=$(aws batch describe-jobs --jobs $JOB_ID \
            --query 'jobs[0].status' --output text)

          echo "Job ID: $JOB_ID"
          echo "Status: $STATUS"

          # Get detailed info
          aws batch describe-jobs --jobs $JOB_ID \
            --query 'jobs[0].{Status:status,CreatedAt:createdAt,StartedAt:startedAt,StoppedAt:stoppedAt,StatusReason:statusReason}' \
            --output table

      - name: Check S3 for completion marker
        run: |
          if aws s3 ls s3://sbir-analytics-data-dev/usaspending/usaspending_dump.sql.gz.complete 2>/dev/null; then
            echo "‚úÖ Download completed successfully"
            aws s3 cp s3://sbir-analytics-data-dev/usaspending/usaspending_dump.sql.gz.complete - | jq .
          else
            echo "‚è≥ Download not yet complete"
          fi

      - name: Check for checkpoint
        run: |
          if aws s3 ls s3://sbir-analytics-data-dev/usaspending/.checkpoints/ 2>/dev/null; then
            echo "üìç Checkpoint found - download in progress"
            aws s3 ls s3://sbir-analytics-data-dev/usaspending/.checkpoints/ --human-readable
          else
            echo "No checkpoint found"
          fi

      - name: No active jobs
        if: steps.get-job.outputs.job_id == 'None' || steps.get-job.outputs.job_id == ''
        run: |
          echo "‚ÑπÔ∏è No active USAspending download jobs found"
          echo "Checking recent completed jobs..."
          aws batch list-jobs \
            --job-queue sbir-analytics-job-queue \
            --job-status SUCCEEDED \
            --max-results 5 \
            --query 'jobSummaryList[?jobName==`usaspending-download`]' \
            --output table
