name: On Commit

on:
  push:
    branches-ignore: []
    # Run on any commit to any branch

jobs:
  static-analysis:
    name: Lint and Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true
      - name: Install dependencies
        run: poetry install --no-interaction
      - name: Run Ruff linter
        run: poetry run ruff check src tests
      - name: Run Ruff formatter check
        run: poetry run ruff format --check src tests
      - name: Run MyPy type checker
        run: poetry run mypy src
      - name: Run Bandit security linter
        run: |
          poetry add --group dev bandit
          poetry run bandit -r src -c pyproject.toml

  secret-scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install pre-commit and detect-secrets
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit detect-secrets
      - name: Run pre-commit hooks (detect-secrets + other configured hooks)
        id: precommit
        run: |  # pragma: allowlist secret
          set -eux
          if [ -f .pre-commit-config.yaml ]; then
            pre-commit run --all-files || exit_code=$? && true
            # Exit code 3 from detect-secrets means baseline was updated (line numbers changed)
            # This is expected and not a security issue. Verify no new secrets were introduced.
            if [ "${exit_code:-0}" = "3" ]; then
              echo "detect-secrets updated baseline (likely due to line number changes from other hooks)."
              echo "Verifying no new secrets were introduced..."
              # Check if baseline file was modified
              if git diff --quiet .secrets.baseline; then
                echo "Baseline was not modified, this is unexpected."
                exit 3
              fi
              # Verify no new secrets: scan with baseline should pass if only line numbers changed
              detect-secrets scan --baseline .secrets.baseline --all-files > /dev/null 2>&1 && scan_result=0 || scan_result=$?
              if [ "$scan_result" = "1" ]; then
                echo "ERROR: New secrets detected that are not in baseline!"
                detect-secrets scan --baseline .secrets.baseline --all-files
                exit 1
              else
                echo "Baseline updated successfully - no new secrets detected (only line number updates)."
                echo "The updated baseline should be committed to keep line numbers current."
              fi
            elif [ "${exit_code:-0}" != "0" ]; then
              echo "pre-commit checks failed (possible secrets detected). See output above for details."
              exit "${exit_code}"
            fi
          else
            echo ".pre-commit-config.yaml not found; running detect-secrets scan directly as fallback."
            detect-secrets scan --all-files --quiet --json > /tmp/detect-secrets.json || exit_code=$? && true
            if [ -s /tmp/detect-secrets.json ]; then
              echo "detect-secrets found findings (no baseline configured). Failing CI to surface potential secrets."
              cat /tmp/detect-secrets.json
              exit 2
            fi
          fi
      - name: Fallback grep scan for common patterns
        run: |  # pragma: allowlist secret
          set -eux
          PATTERNS=(
            "NEO4J_PASSWORD"
            "NEO4J_AUTH"
            "NEO4J_ADMIN_PASSWORD"
            "AWS_ACCESS_KEY_ID"
            "AWS_SECRET_ACCESS_KEY"
            "AKIA[0-9A-Z]{16}"
            "PRIVATE_KEY"
          )
          FOUND=0
          # Exclude directories: docs, archive, .kiro, .github/workflows, scripts
          # Exclude files: *.md, .env.example*, *.py (which reference env var names legitimately)
          EXCLUDE_ARGS="--exclude-dir=.git --exclude-dir=.venv --exclude-dir=docs --exclude-dir=archive --exclude-dir=.kiro --exclude-dir=node_modules"
          EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude=*.png --exclude=*.jpg --exclude=*.md --exclude=.env.example* --exclude=*.py --exclude=*.sh --exclude=*.yml --exclude=*.yaml"

          for p in "${PATTERNS[@]}"; do
            echo "Checking pattern: $p"
            if echo "$p" | grep -q "AKIA"; then
              # Use -P for Perl regex (AKIA pattern)
              # Filter out lines with pragma allowlist secret
              if grep -RInP "$p" $EXCLUDE_ARGS . 2>/dev/null | grep -v "pragma: allowlist secret" | grep -v "^$" || true; then
                # Only set FOUND if there are actual matches
                if [ -n "$(grep -RInP "$p" $EXCLUDE_ARGS . 2>/dev/null | grep -v 'pragma: allowlist secret' || true)" ]; then
                  FOUND=1
                fi
              fi
            else
              # Regular grep for simple string patterns
              if grep -RIn "$p" $EXCLUDE_ARGS . 2>/dev/null | grep -v "pragma: allowlist secret" | grep -v "^$" || true; then
                if [ -n "$(grep -RIn "$p" $EXCLUDE_ARGS . 2>/dev/null | grep -v 'pragma: allowlist secret' || true)" ]; then
                  FOUND=1
                fi
              fi
            fi
          done
          if [ "$FOUND" -ne 0 ]; then
            echo "One or more high-risk secret patterns were detected in the repository."
            echo "These appear to be actual secret values, not just environment variable names."
            echo "Please review the scan output above and ensure no secrets are committed."
            exit 3
          else
            echo "No hardcoded secrets detected (environment variable references and allowlisted patterns excluded)."
          fi
      - name: Upload scan artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-output
          path: |
            detect-secrets-output.json
            .secrets.baseline
          if-no-files-found: ignore

  test:
    name: Fast Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true
      - name: Cache Poetry virtual environment
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-3.11-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-3.11-
      - name: Install dependencies
        run: poetry install --no-interaction --no-root
      - name: Install project
        run: poetry install --no-interaction
      - name: Install duckdb and pyreadstat
        run: |
          poetry run python -m pip install --upgrade pip
          poetry run pip install duckdb pyreadstat
      - name: Run fast tests
        run: poetry run pytest -m fast -v

  docs-link-check:
    name: Docs Link Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Lychee Link Checker
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress --accept 200,429 '**/*.md' '**/*.yaml'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
