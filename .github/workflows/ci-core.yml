name: CI Core

on:
  workflow_call:
    inputs:
      python_version:
        required: false
        type: string
        default: "3.11"
      neo4j_image:
        required: false
        type: string
        default: "neo4j:5"
      neo4j_username:
        required: false
        type: string
        default: "neo4j"
      neo4j_password:
        required: false
        type: string
        default: "password"
    secrets:
      NEO4J_AURA_TEST_URI:
        required: false
      NEO4J_AURA_TEST_USERNAME:
        required: false
      NEO4J_AURA_TEST_PASSWORD:
        required: false
    outputs:
      test-result:
        value: ${{ jobs.test.outputs.result }}
      performance-changed:
        value: ${{ jobs.detect-changes.outputs.performance }}
      cet-changed:
        value: ${{ jobs.detect-changes.outputs.cet }}
      transition-changed:
        value: ${{ jobs.detect-changes.outputs.transition }}
      docker-changed:
        value: ${{ jobs.detect-changes.outputs.docker }}
      docs-only:
        value: ${{ jobs.detect-changes.outputs.docs-only }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    outputs:
      performance: ${{ steps.filter.outputs.performance }}
      cet: ${{ steps.filter.outputs.cet }}
      transition: ${{ steps.filter.outputs.transition }}
      docker: ${{ steps.filter.outputs.docker }}
      docs-only: ${{ steps.filter.outputs.docs-only }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            performance:
              - 'src/enrichers/**'
              - 'src/assets/**'
              - 'src/utils/performance_monitor.py'
              - 'src/extractors/**'
              - 'scripts/performance/benchmark_enrichment.py'
              - 'scripts/performance/detect_performance_regression.py'
              - 'config/base.yaml'
            cet:
              - 'src/**'
              - 'tests/**'
              - 'pyproject.toml'
              - 'uv.lock'
            transition:
              - 'src/assets/transition_assets.py'
              - 'tests/integration/test_transition_mvp_chain.py'
              - 'tests/unit/transition/test_transition_signals_and_boosts.py'
              - 'docs/transition/**'
              - 'Makefile'
              - '.github/workflows/**'
            docker:
              - 'Dockerfile'
              - 'docker-compose.yml'
              - '.dockerignore'
              - 'docker/**'
            docs-only:
              - '**/*.md'
              - 'docs/**'
              - '!**/*.py'
              - '!**/*.yaml'
              - '!**/*.yml'
              - '!**/*.json'
              - '!**/*.toml'
              - '!**/*.lock'
              - '!Makefile'
              - '!.github/**'

  test:
    needs: [detect-changes]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.docs-only != 'true')
    outputs:
      result: ${{ job.status }}
    services:
      neo4j:
        image: ${{ inputs.neo4j_image }}
        ports:
          - 7687:7687
          - 7474:7474
        env:
          NEO4J_AUTH: none
          NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
        options: >-
          ${{ (github.event.inputs.use_docker == 'true' && '--health-cmd "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1" --health-interval 10s --health-timeout 5s --health-retries 10 --health-start-period 40s') || '' }}

    env:
      NEO4J_URI: ${{ (github.event.inputs.use_docker == 'true' && 'bolt://localhost:7687') || secrets.NEO4J_AURA_TEST_URI || 'neo4j+s://test.databases.neo4j.io' }}
      NEO4J_USERNAME: ${{ (github.event.inputs.use_docker == 'true' && 'neo4j') || secrets.NEO4J_AURA_TEST_USERNAME || 'neo4j' }}
      NEO4J_PASSWORD: ${{ (github.event.inputs.use_docker == 'true' && '') || secrets.NEO4J_AURA_TEST_PASSWORD || '' }}
      SBIR_ETL__NEO4J__URI: ${{ (github.event.inputs.use_docker == 'true' && 'bolt://localhost:7687') || secrets.NEO4J_AURA_TEST_URI || 'neo4j+s://test.databases.neo4j.io' }}
      SBIR_ETL__NEO4J__USERNAME: ${{ (github.event.inputs.use_docker == 'true' && 'neo4j') || secrets.NEO4J_AURA_TEST_USERNAME || 'neo4j' }}
      SBIR_ETL__NEO4J__PASSWORD: ${{ (github.event.inputs.use_docker == 'true' && '') || secrets.NEO4J_AURA_TEST_PASSWORD || '' }}
      ENVIRONMENT: ${{ (github.event.inputs.use_docker == 'true' && 'dev') || 'test-aura' }}
      SBIR_ETL__EXTRACTION__SAMPLE_LIMIT: ${{ (github.event.inputs.use_docker == 'true' && '10000') || '1000' }}

    strategy:
      matrix:
        python-version: [${{ inputs.python_version }}]

    steps:
      - uses: actions/checkout@v4

      - name: Display test environment
        run: |
          if [ "${{ github.event.inputs.use_docker }}" = "true" ]; then
            echo "üê≥ Using Docker Neo4j (local service container)"
          else
            echo "‚òÅÔ∏è  Using Neo4j Aura Free (cloud)"
            echo "URI: ${{ env.NEO4J_URI }}"
          fi

      - name: Wait for Neo4j (Docker only)
        if: github.event.inputs.use_docker == 'true'
        run: |
          echo "Waiting for Neo4j Docker service to be ready..."
          until curl -s -f -o /dev/null "http://localhost:7474"; do
            echo "Neo4j not ready, sleeping..."
            sleep 5
          done
          echo "Neo4j is ready!"

      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ matrix.python-version }}
          install-dev-deps: "true"
          cache-venv: "true"
          cache-pytest: "true"
          install-pyreadstat: "true"

      - name: Run taxonomy completeness checks
        if: |
          github.event_name == 'push' ||
          (github.event_name == 'pull_request' && needs.detect-changes.outputs.cet == 'true')
        run: |
          echo "Running CET taxonomy checks (write checks JSON; evaluation in next step)..."
          uv run python -m src.ml.config.taxonomy_checks --output data/processed/cet_taxonomy_checks.json || true

      - name: Evaluate taxonomy checks
        if: |
          github.event_name == 'push' ||
          (github.event_name == 'pull_request' && needs.detect-changes.outputs.cet == 'true')
        run: uv run python scripts/ci/evaluate_taxonomy_checks.py

      - name: Verify pandas, duckdb, and pyreadstat installed
        run: |
          uv run python - <<'PY'
          import pandas, sys
          try:
              import duckdb
              import pyreadstat
              print("pandas", pandas.__version__)
              print("duckdb", duckdb.__version__)
              print("pyreadstat", pyreadstat.__version__)
          except Exception as e:
              print("Dependency verification failed:", e)
              raise
          PY

      - name: Verify Neo4j connection (Aura Free)
        if: github.event.inputs.use_docker != 'true'
        continue-on-error: true
        run: |
          echo "Testing connection to Neo4j Aura Free..."
          uv run python - <<'PY'
          import os
          import sys
          try:
              from neo4j import GraphDatabase
              uri = os.environ.get("NEO4J_URI", "")
              user = os.environ.get("NEO4J_USERNAME", "neo4j")
              password = os.environ.get("NEO4J_PASSWORD", "")

              if not uri or not password:
                  print("‚ö†Ô∏è  Warning: Neo4j Aura test credentials not configured in GitHub secrets")
                  print("   Please configure NEO4J_AURA_TEST_URI, NEO4J_AURA_TEST_USERNAME, NEO4J_AURA_TEST_PASSWORD")
                  sys.exit(0)

              print(f"Connecting to: {uri}")
              driver = GraphDatabase.driver(uri, auth=(user, password))
              with driver.session() as session:
                  result = session.run("RETURN 1 as test")
                  value = result.single()["test"]
                  assert value == 1
              driver.close()
              print("‚úÖ Neo4j Aura Free connection successful!")
          except Exception as e:
              print(f"‚ùå Neo4j Aura Free connection failed: {e}")
              raise
          PY

      - name: Check initial node count (Aura Free)
        if: github.event.inputs.use_docker != 'true'
        continue-on-error: true
        run: |
          echo "Checking Neo4j Aura Free node count before tests..."
          uv run python - <<'PY'
          import os
          import sys
          try:
              from neo4j import GraphDatabase
              uri = os.environ.get("NEO4J_URI", "")
              user = os.environ.get("NEO4J_USERNAME", "neo4j")
              password = os.environ.get("NEO4J_PASSWORD", "")

              if not uri or not password:
                  print("‚ö†Ô∏è  Skipping node count check - no Aura credentials")
                  sys.exit(0)

              driver = GraphDatabase.driver(uri, auth=(user, password))
              with driver.session() as session:
                  result = session.run("MATCH (n) RETURN count(n) as count")
                  count = result.single()["count"]
                  print(f"üìä Current node count: {count:,}")
                  if count > 95000:
                      print(f"‚ö†Ô∏è  WARNING: Node count ({count:,}) approaching Aura Free limit (100,000)")
              driver.close()
          except Exception as e:
              print(f"Note: Could not check node count: {e}")
          PY

      - name: Run fast tests
        env:
          NEO4J_URI: ${{ env.NEO4J_URI }}
          NEO4J_USERNAME: ${{ env.NEO4J_USERNAME }}
          NEO4J_PASSWORD: ${{ env.NEO4J_PASSWORD }}
        run: |
          uv run pytest -m fast --cov=src --cov-report=xml --cov-report=term-missing -n auto

      - name: Clean up Neo4j test data (Aura Free)
        if: always() && github.event.inputs.use_docker != 'true' && env.NEO4J_URI != '' && env.NEO4J_PASSWORD != ''
        continue-on-error: true
        run: |
          echo "Cleaning up Neo4j Aura Free test data..."
          uv run python scripts/ci/cleanup_neo4j_aura.py

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

