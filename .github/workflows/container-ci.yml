name: Container Build & Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  IMAGE_NAME: sbir-etl

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU (optional for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare .env for CI
        run: |
          set -eux
          cp .env.example .env
          # Replace placeholders with repository secrets (ensure secrets exist)
          if [ -n "${{ secrets.NEO4J_PASSWORD }}" ]; then
            sed -i "s|NEO4J_PASSWORD=change_me|NEO4J_PASSWORD=${{ secrets.NEO4J_PASSWORD }}|g" .env || true  # pragma: allowlist secret
          fi
          if [ -n "${{ secrets.NEO4J_USER }}" ]; then
            sed -i "s|NEO4J_USER=neo4j|NEO4J_USER=${{ secrets.NEO4J_USER }}|g" .env || true
          fi
          echo ".env prepared (sensitive values taken from repo secrets)"

      - name: Build image and load into Docker daemon
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Show built image
        run: docker images --format 'table {{.Repository}}:{{.Tag}}\t{{.ID}}\t{{.Size}}' | rg "${{ env.IMAGE_NAME }}" || true

      - name: Smoke test entrypoint
        run: |
          set -eux
          echo "Running smoke test: validate image entrypoint responds to 'dagster --version'"
          # Validate the built image can execute the dagster CLI. The image tag matches the one we built above.
          docker run --rm "${{ env.IMAGE_NAME }}:ci-${{ github.sha }}" dagster --version

      - name: Start test compose and run pytest
        env:
          # Provide the GITHUB_SHA used in the test compose overlay variable
          GITHUB_SHA: ${{ github.sha }}
        run: |
          set -eux
          # Use compose overlay to bring up ephemeral neo4j + app (app configured to run pytest)
          docker compose -f docker-compose.yml -f docker/docker-compose.test.yml up --abort-on-container-exit --build neo4j app
        timeout-minutes: 30

      - name: Tear down test compose (cleanup)
        if: always()
        run: |
          set -eux
          docker compose -f docker-compose.yml -f docker/docker-compose.test.yml down --remove-orphans --volumes || true

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-compose-logs
          path: |
            logs
            reports || true
