name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      neo4j:
        image: neo4j:5
        ports:
          - 7687:7687
          - 7474:7474
        env:
          NEO4J_AUTH: none
          NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
        options: >-
          --health-cmd "curl -f http://localhost:7474 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s

    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Wait for Neo4j
        run: |
          echo "Waiting for Neo4j to be ready..."
          until curl -s -f -o /dev/null "http://localhost:7474"; do
            echo "Neo4j not ready, sleeping..."
            sleep 5
          done
          echo "Neo4j is ready!"

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Cache Poetry virtual environment
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Run taxonomy completeness checks
        run: |
          echo "Running CET taxonomy checks (write checks JSON; evaluation in next step)..."
          # Run checks but don't let this step fail the job immediately; we'll evaluate and comment in the next step.
          poetry run python -m src.ml.config.taxonomy_checks --output data/processed/cet_taxonomy_checks.json || true

      - name: Evaluate taxonomy checks and post PR comment if failures
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'data/processed/cet_taxonomy_checks.json';
            if (!fs.existsSync(path)) {
              console.log(`Checks file not found at ${path}; skipping taxonomy evaluation.`);
              return;
            }
            const data = JSON.parse(fs.readFileSync(path, 'utf8'));
            const completeness = data.completeness || {};
            const missing_required = completeness.missing_required_fields === true;
            let missing_keywords = completeness.areas_missing_keywords_count;
            if (missing_keywords === undefined || missing_keywords === null) {
              missing_keywords = (completeness.areas_missing_keywords || []).length || 0;
            }
            const total = completeness.total_areas || data.cet_count || 0;
            const issues = missing_required || (missing_keywords > 0) || (total != 21);

            if (!issues) {
              console.log('CET taxonomy checks passed.');
              return;
            }

            const pr = context.issue.number;
            const summary = { missing_required, missing_keywords, total };
            const body = `CET taxonomy checks failed.

Summary:
\`\`\`json
${JSON.stringify(summary, null, 2)}
\`\`\`

Please review \`config/cet/taxonomy.yaml\` and address missing keywords, definitions, or update the taxonomy as appropriate.

The checks JSON artifact is available in the workflow run for inspection.`;

            if (pr) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr,
                body
              });
            } else {
              console.log('No PR context; cannot post comment.');
            }

            // Fail the job to ensure taxonomy issues block the CI run (same-run behavior)
            throw new Error('CET taxonomy checks failed â€” see PR comment or pipeline artifact for details.');

      - name: Run tests
        run: poetry run pytest --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Lightweight job to run only ML unit tests (faster feedback for ML changes)
  ml-unit-tests:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.changed_files, 'src/ml') || contains(github.event.pull_request.changed_files, 'tests/unit/ml')
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Cache Poetry virtual environment
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ matrix.python-version }}-mltests-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-${{ matrix.python-version }}-mltests-

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Run ML unit tests
        run: poetry run pytest tests/unit/ml -q
