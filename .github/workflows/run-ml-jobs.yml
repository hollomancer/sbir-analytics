name: Analysis Jobs

on:
  workflow_dispatch:
    inputs:
      job_name:
        description: 'Job to run'
        required: true
        type: choice
        options:
          - cet_full_pipeline
          - paecter_embeddings
          - fiscal_returns_mvp
          - all
      environment:
        description: "Neo4j environment"
        required: true
        default: test
        type: choice
        options:
          - production
          - test

permissions:
  contents: read
  packages: read
  id-token: write

env:
  AWS_REGION: us-east-2
  S3_BUCKET: sbir-etl-production-data
  SBIR_ETL__PIPELINE__ENVIRONMENT: production

jobs:
  # CET runs on GitHub Actions (fits in 7GB)
  cet-pipeline:
    name: CET Classification
    if: github.event.inputs.job_name == 'cet_full_pipeline' || github.event.inputs.job_name == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container:
      image: ghcr.io/hollomancer/sbir-analytics:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install ML dependencies
        run: pip install scikit-learn spacy && python -m spacy download en_core_web_sm

      - name: Run CET pipeline
        env:
          NEO4J_URI: ${{ github.event.inputs.environment == 'test' && secrets.NEO4J_AURA_TEST_URI || secrets.NEO4J_AURA_URI }}
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: ${{ github.event.inputs.environment == 'test' && secrets.NEO4J_AURA_TEST_PASSWORD || secrets.NEO4J_AURA_PASSWORD }}
        run: |
          echo "## ðŸ·ï¸ CET Classification" >> $GITHUB_STEP_SUMMARY
          dagster job execute -m src.definitions -j cet_full_pipeline_job 2>&1 | tee output.txt
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "âœ… CET pipeline completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ CET pipeline failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # PaECTER runs on GitHub Actions (API mode, fits in 7GB)
  paecter-pipeline:
    name: PaECTER Embeddings
    if: github.event.inputs.job_name == 'paecter_embeddings' || github.event.inputs.job_name == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 180
    container:
      image: ghcr.io/hollomancer/sbir-analytics:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install HuggingFace dependencies
        run: pip install huggingface-hub

      - name: Run PaECTER pipeline
        env:
          NEO4J_URI: ${{ github.event.inputs.environment == 'test' && secrets.NEO4J_AURA_TEST_URI || secrets.NEO4J_AURA_URI }}
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: ${{ github.event.inputs.environment == 'test' && secrets.NEO4J_AURA_TEST_PASSWORD || secrets.NEO4J_AURA_PASSWORD }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          PAECTER_MODE: api  # Use API mode, not local model
        run: |
          echo "## ðŸ”¬ PaECTER Embeddings" >> $GITHUB_STEP_SUMMARY
          dagster job execute -m src.definitions -j paecter_job 2>&1 | tee output.txt
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "âœ… PaECTER pipeline completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ PaECTER pipeline failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # Fiscal runs on AWS Batch (needs 8GB+ RAM for R/StateIO)
  fiscal-pipeline:
    name: Fiscal Returns (AWS Batch)
    if: github.event.inputs.job_name == 'fiscal_returns_mvp' || github.event.inputs.job_name == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Submit to AWS Batch
        id: batch
        run: |
          echo "## ðŸ’° Fiscal Returns (AWS Batch)" >> $GITHUB_STEP_SUMMARY

          JOB_ID=$(aws batch submit-job \
            --job-name "fiscal-returns-$(date +%Y%m%d-%H%M%S)" \
            --job-queue "sbir-analytics-analysis-queue" \
            --job-definition "sbir-analytics-analysis-fiscal-returns" \
            --query 'jobId' --output text)

          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "Submitted job: $JOB_ID" >> $GITHUB_STEP_SUMMARY

      - name: Wait for completion
        run: |
          JOB_ID="${{ steps.batch.outputs.job_id }}"
          echo "Waiting for job $JOB_ID..."

          while true; do
            STATUS=$(aws batch describe-jobs --jobs "$JOB_ID" --query 'jobs[0].status' --output text)
            echo "Status: $STATUS"

            if [ "$STATUS" = "SUCCEEDED" ]; then
              echo "âœ… Fiscal job completed" >> $GITHUB_STEP_SUMMARY
              exit 0
            elif [ "$STATUS" = "FAILED" ]; then
              echo "âŒ Fiscal job failed" >> $GITHUB_STEP_SUMMARY
              aws batch describe-jobs --jobs "$JOB_ID" --query 'jobs[0].statusReason' --output text >> $GITHUB_STEP_SUMMARY
              exit 1
            fi

            sleep 30
          done

  summary:
    name: Summary
    needs: [cet-pipeline, paecter-pipeline, fiscal-pipeline]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ“Š Analysis Jobs Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Platform |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| CET | ${{ needs.cet-pipeline.result || 'skipped' }} | GitHub Actions |" >> $GITHUB_STEP_SUMMARY
          echo "| PaECTER | ${{ needs.paecter-pipeline.result || 'skipped' }} | GitHub Actions |" >> $GITHUB_STEP_SUMMARY
          echo "| Fiscal | ${{ needs.fiscal-pipeline.result || 'skipped' }} | AWS Batch |" >> $GITHUB_STEP_SUMMARY
