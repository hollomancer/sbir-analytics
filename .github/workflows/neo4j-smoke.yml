name: Neo4j Smoke Test

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Smoke test mode: "dry-run" (no secrets) or "live" (uses NEO4J credentials from secrets or provided inputs)'
        required: false
        default: dry-run
        type: choice
        options:
          - dry-run
          - live
      NEO4J_USER:
        description: "Optional NEO4J user to use for live mode (overrides repository secret if provided)"
        required: false
        default: ""
        type: string
      NEO4J_PASSWORD:
        description: "Optional NEO4J password to use for live mode (overrides repository secret if provided)"
        required: false
        default: ""
        type: string

jobs:
  neo4j-smoke:
    name: Neo4j smoke
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      COMPOSE_FILE: docker-compose.yml:docker/neo4j.compose.override.yml
      PROFILE: neo4j

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare .env (dry-run or live)
        run: |
          set -eux
          # Ensure we have a .env for compose; start from example if present
          if [ -f .env.example ]; then
            cp .env.example .env || true
          else
            touch .env
          fi

          # If running in live mode, prefer inputs; fall back to repository secrets if inputs are empty.
          if [ "${{ github.event.inputs.mode }}" = "live" ]; then
            # Capture potential inputs (may be empty strings if not provided)
            NEO4J_INPUT_USER="${{ github.event.inputs.NEO4J_USER }}"
            NEO4J_INPUT_PASSWORD="${{ github.event.inputs.NEO4J_PASSWORD }}"

            # If inputs are empty, fall back to repo secrets (may also be empty)
            if [ -z "${NEO4J_INPUT_USER}" ]; then
              NEO4J_INPUT_USER="${{ secrets.NEO4J_USER }}"
            fi
            if [ -z "${NEO4J_INPUT_PASSWORD}" ]; then
              NEO4J_INPUT_PASSWORD="${{ secrets.NEO4J_PASSWORD }}"
            fi

            # Fail if we still do not have a password (cannot proceed in live mode)
            if [ -z "${NEO4J_INPUT_PASSWORD}" ]; then
              echo "NEO4J_PASSWORD not provided via inputs or repository secrets; failing live run."
              exit 2
            fi

            # Append or override values in .env (simple append; prefer inputs first, then secrets)
            echo "NEO4J_USER=${NEO4J_INPUT_USER}" >> .env
            echo "NEO4J_PASSWORD=${NEO4J_INPUT_PASSWORD}" >> .env
            # Optionally set NEO4J_AUTH
            echo "NEO4J_AUTH=${NEO4J_INPUT_USER}/${NEO4J_INPUT_PASSWORD}" >> .env
          else
            echo "Dry-run mode: no secrets injected."
          fi

      - name: Build runtime image used for schema / scripts
        run: |
          set -eux
          # Build the runtime target so we can run schema scripts inside a container attached to the compose network.
          docker build --target runtime -t sbir-etl:smoke .

      - name: Start Neo4j (compose, neo4j profile)
        run: |
          set -eux
          docker compose -f docker-compose.yml -f docker/neo4j.compose.override.yml --profile neo4j up -d --build

      - name: Wait for Neo4j health (make neo4j-check or docker inspect)
        # In live mode we run the Makefile health check which uses cypher-shell (requires credentials).
        # In dry-run mode we wait for the container to appear running/healthy via docker inspect to avoid requiring credentials.
        run: |
          set -eux
          MODE="${{ github.event.inputs.mode }}"
          if [ -z "${MODE}" ]; then MODE="dry-run"; fi
          echo "Health check mode: ${MODE}"
          # Helper: retry loop
          wait_for() {
            cmd="$1"
            tries=0
            until $cmd || [ "$tries" -ge 6 ]; do
              tries=$((tries+1))
              echo "neo4j not ready yet; retry #$tries"
              sleep 5
            done
            if [ "$tries" -ge 6 ]; then
              return 1
            fi
            return 0
          }
          if [ "${MODE}" = "dry-run" ]; then
            echo "Dry-run health check: waiting for neo4j container to be running or report healthy"
            # Prefer health status if available, otherwise check running container presence
            wait_for "sh -c 'status=$(docker inspect --format \"{{.State.Health.Status}}\" sbir-neo4j 2>/dev/null || echo \"\"); \
              if [ \"${status}\" = \"healthy\" ]; then exit 0; fi; \
              if docker ps --filter \"name=sbir-neo4j\" --filter status=running --format \"{{.Names}}\" | grep -q .; then exit 0; fi; exit 1'"
            if [ $? -ne 0 ]; then
              echo "Neo4j did not become ready in time (dry-run)"
              exit 1
            fi
            echo "Neo4j container appears running/healthy (dry-run)"
          else
            echo "Live health check: using Makefile target neo4j-check (requires credentials present)"
            wait_for "make neo4j-check"
            if [ $? -ne 0 ]; then
              echo "Neo4j did not become healthy in time"
              exit 1
            fi
            echo "Neo4j passed live health check"
          fi

      - name: Apply schema (dry-run or live)
        id: apply_schema
        run: |
          set -eux
          # Use the runtime image built above and attach to the compose network so hostname 'neo4j' resolves.
          NETWORK_NAME="sbir-network"
          # Ensure the compose network exists
          docker network inspect "${NETWORK_NAME}" >/dev/null 2>&1 || true

          if [ "${{ github.event.inputs.mode }}" = "dry-run" ]; then
            echo "Running apply_schema in dry-run mode"
            docker run --rm --network "${NETWORK_NAME}" -e NEO4J_URI="bolt://neo4j:7687" sbir-etl:smoke \
              python scripts/neo4j/apply_schema.py --dry-run
          else
            echo "Running apply_schema in live mode (will connect to Neo4j)"
            docker run --rm --network "${NETWORK_NAME}" \
              -e NEO4J_URI="bolt://neo4j:7687" \
              -e NEO4J_USER="${{ secrets.NEO4J_USER }}" \
              -e NEO4J_PASSWORD="${{ secrets.NEO4J_PASSWORD }}" \
              sbir-etl:smoke python scripts/neo4j/apply_schema.py
          fi

      - name: Smoke test - run a simple cypher query (sanity)
        run: |
          set -eux
          # Attempt a lightweight sanity query using cypher-shell inside a short-lived container.
          # Prefer using docker compose exec if possible; fallback to docker run attached to network.
          if command -v docker-compose >/dev/null 2>&1; then
            # Try exec against running neo4j container
            CONTAINER="$(docker ps --filter 'name=sbir-neo4j' --format '{{.Names}}' | head -n1 || true)"
            if [ -n "$CONTAINER" ]; then
              echo "Running cypher-shell sanity query inside container ${CONTAINER}"
              docker exec "$CONTAINER" sh -c "cypher-shell -u ${NEO4J_USER:-neo4j} -p ${NEO4J_PASSWORD:-password} 'RETURN 1' >/dev/null 2>&1"
            else
              echo "Neo4j container not found by name; attempting to run a temporary container attached to compose network"
              docker run --rm --network sbir-network byrnedo/alpine-curl:latest sh -c "apk add --no-cache openjdk11-jre-headless jq || true; echo 'sanity check placeholder'"
            fi
          else
            echo "docker-compose not detected; skipping exec sanity check"
          fi

      # CET minimal asset checks consolidated into neo4j-cet-smoke workflow

      # Always attempt to tear down compose resources (but do not remove named volumes by default)
      - name: Tear down compose (always)
        if: ${{ always() }}
        run: |
          set -eux
          docker compose -f docker-compose.yml -f docker/neo4j.compose.override.yml --profile neo4j down --remove-orphans

      - name: Upload logs and artifacts on failure
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: neo4j-smoke-logs
          path: |
            logs/
            reports/ || true

      - name: Success note
        if: ${{ success() }}
        run: echo "Neo4j smoke test completed successfully (mode=${{ github.event.inputs.mode }})"
