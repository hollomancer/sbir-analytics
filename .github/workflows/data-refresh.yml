name: Data Refresh

on:
  schedule:
    # SBIR Awards: Weekly on Monday at 9 AM UTC
    - cron: "0 9 * * 1"
    # USAspending: Monthly on 6th at 2 AM UTC
    - cron: "0 2 6 * *"
    # USPTO: Monthly on 1st at 9 AM UTC
    - cron: "0 9 1 * *"
  workflow_dispatch:
    inputs:
      source:
        description: "Data source to refresh"
        required: true
        type: choice
        options:
          - sbir
          - usaspending
          - uspto
          - all
      force_refresh:
        description: "Force refresh even if no changes detected"
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read

concurrency:
  group: data-refresh-${{ github.event.inputs.source || 'scheduled' }}
  cancel-in-progress: false

env:
  AWS_REGION: us-east-2
  S3_BUCKET: sbir-etl-production-data

jobs:
  determine-source:
    name: Determine Refresh Source
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      sbir: ${{ steps.determine.outputs.sbir }}
      usaspending: ${{ steps.determine.outputs.usaspending }}
      uspto: ${{ steps.determine.outputs.uspto }}
    steps:
      - name: Determine which sources to refresh
        id: determine
        run: |
          # Manual trigger
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SOURCE="${{ github.event.inputs.source }}"
            if [ "$SOURCE" = "all" ]; then
              echo "sbir=true" >> $GITHUB_OUTPUT
              echo "usaspending=true" >> $GITHUB_OUTPUT
              echo "uspto=true" >> $GITHUB_OUTPUT
            else
              echo "sbir=$([[ $SOURCE == 'sbir' ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "usaspending=$([[ $SOURCE == 'usaspending' ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "uspto=$([[ $SOURCE == 'uspto' ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            fi
          # Scheduled trigger - determine by cron schedule
          else
            CRON_SCHEDULE="${{ github.event.schedule }}"
            case "$CRON_SCHEDULE" in
              "0 9 * * 1")  # Weekly Monday
                echo "sbir=true" >> $GITHUB_OUTPUT
                echo "usaspending=false" >> $GITHUB_OUTPUT
                echo "uspto=false" >> $GITHUB_OUTPUT
                ;;
              "0 2 6 * *")  # Monthly 6th
                echo "sbir=false" >> $GITHUB_OUTPUT
                echo "usaspending=true" >> $GITHUB_OUTPUT
                echo "uspto=false" >> $GITHUB_OUTPUT
                ;;
              "0 9 1 * *")  # Monthly 1st
                echo "sbir=false" >> $GITHUB_OUTPUT
                echo "usaspending=false" >> $GITHUB_OUTPUT
                echo "uspto=true" >> $GITHUB_OUTPUT
                ;;
            esac
          fi

      - name: Generate workflow summary
        run: |
          echo "## ðŸ“Š Data Refresh Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```mermaid" >> $GITHUB_STEP_SUMMARY
          echo "graph LR" >> $GITHUB_STEP_SUMMARY
          echo "  A[Determine Source] --> B{Which Source?}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.determine.outputs.sbir }}" = "true" ]; then
            echo "  B -->|SBIR| C[Refresh SBIR Awards]" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.determine.outputs.usaspending }}" = "true" ]; then
            echo "  B -->|USAspending| D[Refresh USAspending DB]" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.determine.outputs.uspto }}" = "true" ]; then
            echo "  B -->|USPTO| E[Refresh USPTO Patents]" >> $GITHUB_STEP_SUMMARY
          fi
          echo "```" >> $GITHUB_STEP_SUMMARY

  refresh-sbir:
    name: Refresh SBIR Awards
    needs: determine-source
    if: needs.determine-source.outputs.sbir == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: ./.github/actions/setup-aws-credentials
        with:
          role-arn: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Start SBIR refresh Step Functions
        id: sbir-stepfunctions
        run: |
          echo "## ðŸŽ¯ SBIR Awards Refresh Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          INPUT_PAYLOAD=$(jq -n \
            --arg force_refresh "${{ github.event.inputs.force_refresh || 'false' }}" \
            --arg s3_bucket "${{ env.S3_BUCKET }}" \
            '{
              force_refresh: ($force_refresh == "true"),
              s3_bucket: $s3_bucket
            }')

          echo "### âš™ï¸ Configuration" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "$INPUT_PAYLOAD" | jq '.' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          EXECUTION=$(aws stepfunctions start-execution \
            --state-machine-arn "${{ secrets.STEP_FUNCTIONS_STATE_MACHINE_ARN }}" \
            --input "$INPUT_PAYLOAD" \
            --region ${{ env.AWS_REGION }})

          EXECUTION_ARN=$(echo $EXECUTION | jq -r '.executionArn')
          EXECUTION_NAME=$(echo $EXECUTION_ARN | rev | cut -d: -f1 | rev)
          START_DATE=$(echo $EXECUTION | jq -r '.startDate')

          echo "execution_arn=$EXECUTION_ARN" >> $GITHUB_OUTPUT

          echo "### âœ… Step Functions Execution Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Execution Name** | \`$EXECUTION_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Started At** | $START_DATE |" >> $GITHUB_STEP_SUMMARY
          echo "| **State Machine** | SBIR ETL Pipeline |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Monitor execution:** [AWS Console](https://console.aws.amazon.com/states/home?region=${{ env.AWS_REGION }}#/executions/details/$EXECUTION_ARN)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> â„¹ï¸ The Step Functions workflow will continue running asynchronously. Check the AWS Console link above to monitor progress." >> $GITHUB_STEP_SUMMARY

  refresh-usaspending:
    name: Refresh USAspending Database
    needs: determine-source
    if: needs.determine-source.outputs.usaspending == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 90  # Reduced from 180 with parallel download
    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: ./.github/actions/setup-aws-credentials
        with:
          role-arn: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: "3.11"
          install-dev-deps: "false"

      - name: Install async dependencies
        run: |
          uv pip install aiohttp aioboto3

      - name: Download and process USAspending database (parallel)
        id: usaspending-download
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 90
          max_attempts: 3
          retry_wait_seconds: 60
          command: |
            uv run python scripts/data/download_usaspending_parallel.py \
              --s3-bucket ${{ env.S3_BUCKET }} \
              --database-type full \
              --max-concurrent 10 2>&1 | tee usaspending_output.txt

      - name: Report USAspending status
        if: always()
        run: |
          echo "## ðŸ’¾ USAspending Database Download Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if download was successful
          if [ "${{ steps.usaspending-download.outcome }}" = "success" ]; then
            echo "### âœ… Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Status: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract and display key metrics from output
          if [ -f usaspending_output.txt ]; then
            echo "### ðŸ“Š Download Metrics" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            # Extract key information
            grep -E "^(ðŸ“Š|ðŸ“¦|â±ï¸|âš¡|ðŸ“|âœ¨)" usaspending_output.txt | tail -20 || echo "No metrics found"

            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show final summary section if it exists
            if grep -q "DOWNLOAD COMPLETE" usaspending_output.txt; then
              echo "### âœ¨ Completion Summary" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              sed -n '/DOWNLOAD COMPLETE/,/^=\+$/p' usaspending_output.txt | head -20 >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi

            # Show error details if failed
            if grep -q "ERROR DURING DOWNLOAD" usaspending_output.txt; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âŒ Error Details" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              sed -n '/ERROR DURING DOWNLOAD/,/^=\+$/p' usaspending_output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No output file found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ S3 Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "Latest files in s3://${{ env.S3_BUCKET }}/raw/usaspending/database/:" >> $GITHUB_STEP_SUMMARY
          aws s3 ls s3://${{ env.S3_BUCKET }}/raw/usaspending/database/ --recursive --human-readable | tail -5 || echo "No files found"
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Full Output Log" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click to expand full output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ -f usaspending_output.txt ]; then
            cat usaspending_output.txt >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

  refresh-uspto:
    name: Refresh USPTO Patents
    needs: determine-source
    if: needs.determine-source.outputs.uspto == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: ./.github/actions/setup-aws-credentials
        with:
          role-arn: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: "3.11"
          install-dev-deps: "false"

      - name: Trigger USPTO data downloads via Lambda
        id: uspto-lambda
        run: |
          echo "## ðŸ“¥ USPTO Patent Data Download Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          LAMBDA_SUCCESS=true

          # PatentsView
          echo "### 1ï¸âƒ£ PatentsView Data" >> $GITHUB_STEP_SUMMARY
          if aws lambda invoke --function-name sbir-analytics-download-uspto-patentsview response.json; then
            echo "âœ… Lambda invoked successfully" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat response.json | jq '.' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to invoke Lambda" >> $GITHUB_STEP_SUMMARY
            LAMBDA_SUCCESS=false
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Assignments
          echo "### 2ï¸âƒ£ Patent Assignments" >> $GITHUB_STEP_SUMMARY
          if aws lambda invoke --function-name sbir-analytics-download-uspto-assignments response.json; then
            echo "âœ… Lambda invoked successfully" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat response.json | jq '.' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to invoke Lambda" >> $GITHUB_STEP_SUMMARY
            LAMBDA_SUCCESS=false
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # AI Patents
          echo "### 3ï¸âƒ£ AI Patents" >> $GITHUB_STEP_SUMMARY
          if aws lambda invoke --function-name sbir-analytics-download-uspto-ai-patents response.json; then
            echo "âœ… Lambda invoked successfully" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat response.json | jq '.' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to invoke Lambda" >> $GITHUB_STEP_SUMMARY
            LAMBDA_SUCCESS=false
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$LAMBDA_SUCCESS" = "false" ]; then
            echo "::warning::One or more USPTO Lambda functions failed to execute"
            exit 1
          fi

      - name: Check S3 uploads
        if: always()
        run: |
          echo "## ðŸ“¦ USPTO S3 Upload Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“‚ Latest Files by Category" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**PatentsView:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws s3 ls s3://${{ env.S3_BUCKET }}/uspto/patentsview/ --recursive --human-readable | tail -3 || echo "No files found"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**Assignments:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws s3 ls s3://${{ env.S3_BUCKET }}/uspto/assignments/ --recursive --human-readable | tail -3 || echo "No files found"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**AI Patents:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws s3 ls s3://${{ env.S3_BUCKET }}/uspto/ai-patents/ --recursive --human-readable | tail -3 || echo "No files found"
          echo '```' >> $GITHUB_STEP_SUMMARY

  summary:
    name: Refresh Summary
    needs: [determine-source, refresh-sbir, refresh-usaspending, refresh-uspto]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ“Š Data Refresh Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "**Requested Source:** ${{ github.event.inputs.source }}" >> $GITHUB_STEP_SUMMARY
            echo "**Force Refresh:** ${{ github.event.inputs.force_refresh }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          OVERALL_SUCCESS=true

          # Count statuses
          TOTAL=0
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          SKIPPED_COUNT=0

          echo "## ðŸ“‹ Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Data Source | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.determine-source.outputs.sbir }}" = "true" ]; then
            TOTAL=$((TOTAL + 1))
            STATUS="${{ needs.refresh-sbir.result }}"
            if [ "$STATUS" = "success" ]; then
              EMOJI="âœ…"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              RESULT="Successfully started Step Functions execution"
            elif [ "$STATUS" = "failure" ]; then
              EMOJI="âŒ"
              FAILED_COUNT=$((FAILED_COUNT + 1))
              RESULT="Failed to start execution - check logs"
              OVERALL_SUCCESS=false
            else
              EMOJI="â­ï¸"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
              RESULT="Job was skipped or cancelled"
            fi
            echo "| ðŸŽ¯ SBIR Awards | $EMOJI $STATUS | $RESULT |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.determine-source.outputs.usaspending }}" = "true" ]; then
            TOTAL=$((TOTAL + 1))
            STATUS="${{ needs.refresh-usaspending.result }}"
            if [ "$STATUS" = "success" ]; then
              EMOJI="âœ…"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              RESULT="Database downloaded and uploaded to S3"
            elif [ "$STATUS" = "failure" ]; then
              EMOJI="âŒ"
              FAILED_COUNT=$((FAILED_COUNT + 1))
              RESULT="Download or upload failed - check detailed report above"
              OVERALL_SUCCESS=false
            else
              EMOJI="â­ï¸"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
              RESULT="Job was skipped or cancelled"
            fi
            echo "| ðŸ’° USAspending DB | $EMOJI $STATUS | $RESULT |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.determine-source.outputs.uspto }}" = "true" ]; then
            TOTAL=$((TOTAL + 1))
            STATUS="${{ needs.refresh-uspto.result }}"
            if [ "$STATUS" = "success" ]; then
              EMOJI="âœ…"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              RESULT="Patent data downloaded via Lambda functions"
            elif [ "$STATUS" = "failure" ]; then
              EMOJI="âŒ"
              FAILED_COUNT=$((FAILED_COUNT + 1))
              RESULT="Lambda invocation failed - check logs"
              OVERALL_SUCCESS=false
            else
              EMOJI="â­ï¸"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
              RESULT="Job was skipped or cancelled"
            fi
            echo "| ðŸ“œ USPTO Patents | $EMOJI $STATUS | $RESULT |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Statistics
          echo "## ðŸ“ˆ Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total jobs:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Successful:** $SUCCESS_COUNT âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_COUNT âŒ" >> $GITHUB_STEP_SUMMARY
          echo "- **Skipped:** $SKIPPED_COUNT â­ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Final verdict
          if [ "$OVERALL_SUCCESS" = "true" ] && [ "$TOTAL" -gt 0 ]; then
            echo "## âœ… Overall Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All data refresh jobs completed successfully!" >> $GITHUB_STEP_SUMMARY
          elif [ "$TOTAL" -eq 0 ]; then
            echo "## âš ï¸ Overall Status: NO JOBS RUN" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No data sources were selected for refresh." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Overall Status: FAILURES DETECTED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ One or more data refresh jobs failed. Please review the detailed reports above and check the job logs." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow completed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket:** \`${{ env.S3_BUCKET }}\`" >> $GITHUB_STEP_SUMMARY
