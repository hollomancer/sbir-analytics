name: Static Analysis

on:
  pull_request:
  push:
    branches: [main, develop]
    # Only run on PRs and pushes to main/develop to reduce CI minutes

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    # Only run change detection on PRs to optimize CI time
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: read
    outputs:
      code-changed: ${{ steps.filter.outputs.code-changed }}
      docs-only: ${{ steps.filter.outputs.docs-only }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            code-changed:
              - 'src/**'
              - 'tests/**'
              - '*.py'
              - 'pyproject.toml'
              - 'uv.lock'
            docs-only:
              - '**/*.md'
              - 'docs/**'
              - '!**/*.py'
              - '!**/*.yaml'
              - '!**/*.yml'
              - '!**/*.json'
              - '!**/*.toml'
              - '!**/*.lock'
              - '!Makefile'
              - '!.github/**'

  lint:
    name: Ruff Lint
    needs: [detect-changes]
    runs-on: ubuntu-latest
    # Skip on docs-only PRs (always run on push to main/develop)
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.code-changed == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'uv'
      - name: Cache UV installation
        id: cache-uv
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin/uv
          key: uv-install-${{ runner.os }}
          restore-keys: |
            uv-install-
      - name: Install UV (if not cached)
        if: steps.cache-uv.outputs.cache-hit != 'true'
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Install dependencies
        run: uv sync
      - name: Run Ruff linter
        run: uv run ruff check src tests

  format-check:
    name: Ruff Format Check
    needs: [detect-changes]
    runs-on: ubuntu-latest
    # Skip on docs-only PRs (always run on push to main/develop)
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.code-changed == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'uv'
      - name: Cache UV installation
        id: cache-uv
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin/uv
          key: uv-install-${{ runner.os }}
          restore-keys: |
            uv-install-
      - name: Install UV (if not cached)
        if: steps.cache-uv.outputs.cache-hit != 'true'
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Install dependencies
        run: uv sync
      - name: Run Ruff formatter check
        run: uv run ruff format --check src tests

  type-check:
    name: MyPy Type Check
    needs: [detect-changes]
    runs-on: ubuntu-latest
    # Skip on docs-only PRs (always run on push to main/develop)
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.code-changed == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'uv'
      - name: Cache UV installation
        id: cache-uv
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin/uv
          key: uv-install-${{ runner.os }}
          restore-keys: |
            uv-install-
      - name: Install UV (if not cached)
        if: steps.cache-uv.outputs.cache-hit != 'true'
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Install dependencies
        run: uv sync
      - name: Run MyPy type checker
        run: uv run mypy src

  security-scan:
    name: Bandit Security Scan
    needs: [detect-changes]
    runs-on: ubuntu-latest
    # Skip on docs-only PRs (always run on push to main/develop)
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.code-changed == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'uv'
      - name: Cache UV installation
        id: cache-uv
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin/uv
          key: uv-install-${{ runner.os }}
          restore-keys: |
            uv-install-
      - name: Install UV (if not cached)
        if: steps.cache-uv.outputs.cache-hit != 'true'
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Install dependencies
        run: uv sync
      - name: Run Bandit security linter
        run: uv run bandit -r src -c pyproject.toml

  secret-scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Reduced from 30 - secret scanning shouldn't take that long
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: pip-packages-${{ runner.os }}-precommit-detect-secrets
          restore-keys: |
            pip-packages-${{ runner.os }}-
      - name: Install pre-commit and detect-secrets
        run: |
          python -m pip install --upgrade pip
          pip install --cache-dir ~/.cache/pip pre-commit detect-secrets
      - name: Run pre-commit hooks (detect-secrets + other configured hooks)
        id: precommit
        run: |  # pragma: allowlist secret
          set -eux
          if [ -f .pre-commit-config.yaml ]; then
            pre-commit run --all-files || exit_code=$? && true
            # Exit code 3 from detect-secrets means baseline was updated (line numbers changed)
            # This is expected and not a security issue. Verify no new secrets were introduced.
            if [ "${exit_code:-0}" = "3" ]; then
              echo "detect-secrets updated baseline (likely due to line number changes from other hooks)."
              echo "Verifying no new secrets were introduced..."
              # Check if baseline file was modified
              if git diff --quiet .secrets.baseline; then
                echo "Baseline was not modified, this is unexpected."
                exit 3
              fi
              # Verify no new secrets: scan with baseline should pass if only line numbers changed
              detect-secrets scan --baseline .secrets.baseline --all-files > /dev/null 2>&1 && scan_result=0 || scan_result=$?
              if [ "$scan_result" = "1" ]; then
                echo "ERROR: New secrets detected that are not in baseline!"
                detect-secrets scan --baseline .secrets.baseline --all-files
                exit 1
              else
                echo "Baseline updated successfully - no new secrets detected (only line number updates)."
                echo "The updated baseline should be committed to keep line numbers current."
              fi
            elif [ "${exit_code:-0}" != "0" ]; then
              echo "pre-commit checks failed (possible secrets detected). See output above for details."
              exit "${exit_code}"
            fi
          else
            echo ".pre-commit-config.yaml not found; running detect-secrets scan directly as fallback."
            detect-secrets scan --all-files --quiet --json > /tmp/detect-secrets.json || exit_code=$? && true
            if [ -s /tmp/detect-secrets.json ]; then
              echo "detect-secrets found findings (no baseline configured). Failing CI to surface potential secrets."
              cat /tmp/detect-secrets.json
              exit 2
            fi
          fi
      - name: Fallback grep scan for common patterns
        run: |  # pragma: allowlist secret
          set -eux
          PATTERNS=(
            "NEO4J_PASSWORD"
            "NEO4J_AUTH"
            "NEO4J_ADMIN_PASSWORD"
            "AWS_ACCESS_KEY_ID"
            "AWS_SECRET_ACCESS_KEY"
            "AKIA[0-9A-Z]{16}"
            "PRIVATE_KEY"
          )
          FOUND=0
          # Exclude directories: docs, archive, .kiro, scripts, caches
          # Exclude files: *.md, .env.example*, *.py (which reference env var names legitimately)
          EXCLUDE_ARGS="--exclude-dir=.git --exclude-dir=.venv --exclude-dir=docs --exclude-dir=archive --exclude-dir=.kiro --exclude-dir=node_modules --exclude-dir=.mypy_cache --exclude-dir=.pytest_cache --exclude-dir=.ruff_cache --exclude-dir=scripts --exclude-dir=config"
          EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude=*.png --exclude=*.jpg --exclude=*.md --exclude=.env.example* --exclude=*.py --exclude=*.sh --exclude=*.yml --exclude=*.yaml --exclude=Makefile --exclude=*.conf --exclude=*.json"

          for p in "${PATTERNS[@]}"; do
            echo "Checking pattern: $p"
            if echo "$p" | grep -q "AKIA"; then
              # Use -P for Perl regex (AKIA pattern)
              # Filter out lines with pragma allowlist secret
              if grep -RInP "$p" $EXCLUDE_ARGS . 2>/dev/null | grep -v "pragma: allowlist secret" | grep -v "^$" || true; then
                # Only set FOUND if there are actual matches
                if [ -n "$(grep -RInP "$p" $EXCLUDE_ARGS . 2>/dev/null | grep -v 'pragma: allowlist secret' || true)" ]; then
                  FOUND=1
                  break  # Early exit on first match
                fi
              fi
            else
              # Regular grep for simple string patterns
              if grep -RIn "$p" $EXCLUDE_ARGS . 2>/dev/null | grep -v "pragma: allowlist secret" | grep -v "^$" || true; then
                if [ -n "$(grep -RIn "$p" $EXCLUDE_ARGS . 2>/dev/null | grep -v 'pragma: allowlist secret' || true)" ]; then
                  FOUND=1
                  break  # Early exit on first match
                fi
              fi
            fi
          done
          if [ "$FOUND" -ne 0 ]; then
            echo "One or more high-risk secret patterns were detected in the repository."
            echo "These appear to be actual secret values, not just environment variable names."
            echo "Please review the scan output above and ensure no secrets are committed."
            exit 3
          else
            echo "No hardcoded secrets detected (environment variable references and allowlisted patterns excluded)."
          fi
      - name: Upload scan artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-output
          path: |
            detect-secrets-output.json
            .secrets.baseline
          if-no-files-found: ignore

  docs-link-check:
    name: Docs Link Check
    needs: [detect-changes]
    runs-on: ubuntu-latest
    # Only run when docs files change or on push to main/develop
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.docs-only == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Lychee Link Checker
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress --accept 200,429 '**/*.md' '**/*.yaml'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
