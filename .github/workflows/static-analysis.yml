name: Static Analysis

# Permissions: Minimal required permissions for security
permissions:
  contents: read
  pull-requests: read

on:
  pull_request:
  push:
    branches: [main, develop]
    # Only run on PRs and pushes to main/develop to reduce CI minutes

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    outputs:
      code-changed: ${{ steps.filter.outputs.code-changed }}
      docs-only: ${{ steps.filter.outputs.docs-only }}
    steps:
      - uses: actions/checkout@v4
      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            code-changed:
              - 'src/**'
              - 'tests/**'
              - '*.py'
              - 'pyproject.toml'
              - 'uv.lock'
            docs-only:
              - '**/*.md'
              - 'docs/**'
              - '!**/*.py'
              - '!**/*.yaml'
              - '!**/*.yml'
              - '!**/*.json'
              - '!**/*.toml'
              - '!**/*.lock'
              - '!Makefile'
              - '!.github/**'

  # Split analysis into parallel jobs for faster execution
  lint:
    name: Lint (Ruff)
    needs: [detect-changes]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.code-changed == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: "3.11"
          install-dev-deps: "true"
          cache-venv: "true"
          cache-pytest: "false"
          install-pyreadstat: "false"
      - name: Ensure Ruff is installed
        run: |
          uv pip install ruff
          uv run python -m ruff --version
      - name: Run Ruff lint
        run: uv run python -m ruff check src tests
      - name: Run Ruff format check
        run: uv run python -m ruff format --check src tests

  types:
    name: Type Check (MyPy)
    needs: [detect-changes]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.code-changed == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: "3.11"
          install-dev-deps: "true"
          cache-venv: "true"
          cache-pytest: "false"
          install-pyreadstat: "false"
      - name: Ensure MyPy is installed
        run: |
          uv pip install mypy
          uv run python -m mypy --version
      - name: Run MyPy type checker
        run: uv run python -m mypy src

  security:
    name: Security Scan (Bandit)
    needs: [detect-changes]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.code-changed == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: "3.11"
          install-dev-deps: "true"
          cache-venv: "true"
          cache-pytest: "false"
          install-pyreadstat: "false"
      - name: Run Bandit
        run: uv run python -m bandit -r src -c pyproject.toml

  docs-link-check:
    name: Docs Link Check
    needs: [detect-changes]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Only run when docs files change or on push to main/develop
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.docs-only == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Lychee Link Checker
        uses: lycheeverse/lychee-action@v2
        with:
          args: --verbose --no-progress --accept 200,301,302,307,429,401,403,404 --exclude-all-private --exclude '^http://localhost' --exclude '^https://cloud.dagster.io' --exclude '^https://status.dagster.io' --exclude '^https://techstart.com' --exclude '^https://bulkdata.uspto.gov' --exclude '^https://huggingface\.co/settings/tokens' --exclude '^https://www\.dnb\.com' '**/*.md' '**/*.yaml'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
