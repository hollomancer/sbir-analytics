name: Static Analysis

# Permissions: Minimal required permissions for security
permissions:
  contents: read
  pull-requests: read

on:
  pull_request:
  push:
    branches: [main, develop]
    # Only run on PRs and pushes to main/develop to reduce CI minutes

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    outputs:
      code-changed: ${{ steps.detect.outputs.code-changed }}
      docs-only: ${{ steps.detect.outputs.docs-only }}
    steps:
      - uses: actions/checkout@v4
      - name: Detect changes
        id: detect
        uses: ./.github/actions/detect-changes
        with:
          filters: |
            code-changed:
              - 'src/**'
              - 'tests/**'
              - '*.py'
              - 'pyproject.toml'
              - 'uv.lock'
            docs-only:
              - '**/*.md'
              - 'docs/**'
              - '!**/*.py'
              - '!**/*.yaml'
              - '!**/*.yml'
              - '!**/*.json'
              - '!**/*.toml'
              - '!**/*.lock'
              - '!Makefile'
              - '!.github/**'

  # Run all pre-commit hooks for comprehensive local/CI consistency check
  pre-commit-check:
    name: Pre-commit Hooks (Local/CI Consistency)
    needs: [detect-changes]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.code-changed == 'true')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for detect-secrets to work properly
      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: "3.11"
          install-dev-deps: "true"
          cache-venv: "true"
          cache-pytest: "false"
          install-pyreadstat: "false"
      - name: Install pre-commit
        run: |
          uv pip install pre-commit
          pre-commit --version
      - name: Run all pre-commit hooks
        run: pre-commit run --all-files
        env:
          SKIP: docs-link-check # Skip external link checks in CI to avoid rate limiting

  # Split analysis into parallel jobs for faster execution
  # Note: These individual jobs run the same commands as pre-commit hooks
  # to ensure consistency between local development and CI. See .pre-commit-config.yaml.
  lint:
    name: Lint (Ruff)
    needs: [detect-changes]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.code-changed == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: "3.11"
          install-dev-deps: "true"
          cache-venv: "true"
          cache-pytest: "false"
          install-pyreadstat: "false"
      - name: Ensure Ruff is installed
        run: |
          uv pip install ruff
          uv run python -m ruff --version
      - name: "Run Ruff lint (matches pre-commit: ruff check src tests)"
        run: uv run python -m ruff check src tests
      - name: "Run Ruff format check (matches pre-commit: ruff format src tests)"
        run: uv run python -m ruff format --check src tests

  types:
    name: Type Check (MyPy)
    needs: [detect-changes]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.code-changed == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: "3.11"
          install-dev-deps: "true"
          cache-venv: "true"
          cache-pytest: "false"
          install-pyreadstat: "false"
      - name: Ensure MyPy is installed
        run: |
          uv pip install mypy
          uv run python -m mypy --version
      - name: "Run MyPy type checker (matches pre-commit: mypy src)"
        run: uv run python -m mypy src

  security:
    name: Security Scan (Bandit)
    needs: [detect-changes]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.code-changed == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: "3.11"
          install-dev-deps: "true"
          cache-venv: "true"
          cache-pytest: "false"
          install-pyreadstat: "false"
      - name: "Run Bandit (matches pre-commit: bandit -r src -c pyproject.toml)"
        run: uv run python -m bandit -r src -c pyproject.toml

  docs-link-check:
    name: Docs Link Check
    needs: [detect-changes]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Only run when docs files change or on push to main/develop
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && needs.detect-changes.outputs.docs-only == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Lychee Link Checker
        uses: lycheeverse/lychee-action@v2
        with:
          args: --verbose --no-progress --accept 200,301,302,307,429,401,403,404 --exclude-all-private --exclude '^http://localhost' --exclude '^https://cloud.dagster.io' --exclude '^https://status.dagster.io' --exclude '^https://techstart.com' --exclude '^https://bulkdata.uspto.gov' --exclude '^https://huggingface\.co/settings/tokens' --exclude '^https://www\.dnb\.com' '**/*.md' '**/*.yaml'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
