# Consolidated Docker Compose Configuration for SBIR ETL Pipeline
#
# This file provides a simplified two-profile configuration:
# - dev: Development environment with bind mounts for live editing
# - ci: CI/testing environment with named volumes for isolation
#
# Usage Examples:
#   # Development (bind mounts, live reload)
#   docker compose --profile dev up --build
#
#   # CI Testing (ephemeral volumes, test execution)
#   docker compose --profile ci up --build
#
# Environment Variables (set via .env file):
#   - COMPOSE_PROFILES: Comma-separated list of profiles to activate
#   - ENVIRONMENT: dev|test (controls behavior)
#   - NEO4J_USER / NEO4J_PASSWORD: Database credentials
#   - IMAGE_NAME / IMAGE_TAG: Container image configuration

x-common-environment: &common-environment
  ENVIRONMENT: ${ENVIRONMENT:-dev}
  PYTHONPATH: /app
  PYTHONUNBUFFERED: 1
  SERVICE_STARTUP_TIMEOUT: ${SERVICE_STARTUP_TIMEOUT:-120}
  # Neo4j connection settings
  SBIR_ETL__NEO4J__HOST: ${SBIR_ETL__NEO4J__HOST:-neo4j}
  SBIR_ETL__NEO4J__PORT: ${SBIR_ETL__NEO4J__PORT:-7687}
  NEO4J_URI: ${NEO4J_URI:-bolt://neo4j:7687}
  NEO4J_USER: ${NEO4J_USER:-neo4j}
  NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}

x-dev-environment: &dev-environment
  <<: *common-environment
  ENVIRONMENT: "dev"
  NEO4J_USER: "${NEO4J_USER:-neo4j}"
  NEO4J_PASSWORD: "${NEO4J_PASSWORD:-test}"

x-ci-environment: &ci-environment
  <<: *common-environment
  ENVIRONMENT: "test"
  NEO4J_USER: "${NEO4J_USER}"
  NEO4J_PASSWORD: "${NEO4J_PASSWORD}"

x-healthcheck-neo4j: &healthcheck-neo4j
  test:
    - "CMD-SHELL"
    - "cypher-shell -u ${NEO4J_USER:-neo4j} -p ${NEO4J_PASSWORD:-password} 'RETURN 1' >/dev/null 2>&1 || exit 1"
  interval: 10s
  timeout: 5s
  retries: 12
  start_period: 10s

x-healthcheck-dagster: &healthcheck-dagster
  test:
    - "CMD-SHELL"
    - "curl -fsS --max-time 3 http://localhost:${HEALTHCHECK_PORT:-3000}${HEALTHCHECK_PATH:-/server_info} || exit 1"
  interval: 10s
  timeout: 3s
  retries: 5
  start_period: 5s

x-healthcheck-daemon: &healthcheck-daemon
  test: ["CMD-SHELL", "ps aux | grep -q 'dagster-daemon' || exit 1"]
  interval: 20s
  timeout: 5s
  retries: 3
  start_period: 10s

x-resource-limits: &resource-limits
  deploy:
    resources:
      limits:
        memory: 2G
        cpus: '1.0'
      reservations:
        memory: 1G
        cpus: '0.5'

services:
  # =============================================================================
  # Neo4j Database Service
  # =============================================================================
  neo4j:
    image: neo4j:${NEO4J_VERSION:-5.20.0}
    container_name: ${NEO4J_CONTAINER_NAME:-sbir-neo4j}
    profiles:
      - ci
      - dev
    environment:
      # Prefer explicit NEO4J_AUTH if set, otherwise construct from user/password
      - NEO4J_AUTH=${NEO4J_AUTH:-${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-password}}
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
      - NEO4J_PLUGINS=${NEO4J_PLUGINS:-'["apoc"]'}
      - NEO4J_server_memory_heap_max__size=${NEO4J_server_memory_heap_max__size:-1G}
      - NEO4J_server_memory_heap_initial__size=${NEO4J_server_memory_heap_initial__size:-512M}
      - NEO4J_server_memory_pagecache_size=${NEO4J_server_memory_pagecache_size:-256M}
      - NEO4J_db_logs_query_enabled=${NEO4J_db_logs_query_enabled:-OFF}
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"
      - "${NEO4J_BOLT_PORT:-7687}:7687"
    volumes:
      # Use named volumes for isolation (works for both dev and CI)
      # Dev can override via .env or use bind mounts by mounting ./data/neo4j
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      # Optional configuration overrides (if files exist)
      - ./config/neo4j/neo4j.conf:/var/lib/neo4j/conf/neo4j.conf:ro
      - ./config/neo4j/certs:/certs:ro
      - ./config/neo4j/plugins:/plugins:rw
    networks:
      - sbir-network
    healthcheck: *healthcheck-neo4j
    restart: ${NEO4J_RESTART_POLICY:-unless-stopped}
    <<: *resource-limits

  # =============================================================================
  # Dagster Webserver Service
  # =============================================================================
  dagster-webserver:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    image: ${IMAGE_NAME:-sbir-etl}:${IMAGE_TAG:-local}
    container_name: ${DAGSTER_WEBSERVER_CONTAINER_NAME:-sbir-dagster-web}
    profiles:
      - ci
      - dev
    environment:
      <<: *common-environment
      ENABLE_WATCHFILES: ${ENABLE_WATCHFILES:-0}
      ENV_DAGSTER_CMD: ${ENV_DAGSTER_CMD:-dagster dev -h 0.0.0.0 -p 3000}
      HEALTHCHECK_PORT: ${DAGSTER_PORT:-3000}
      HEALTHCHECK_PATH: ${DAGSTER_HEALTH_PATH:-/server_info}
    volumes:
      # Bind mounts work for both dev (live editing) and CI (ephemeral runner filesystem)
      - ./src:/app/src:rw
      - ./config:/app/config:rw
      - ./.env:/app/.env:ro
      - ./reports:/app/reports:rw
      - ./logs:/app/logs:rw
      - ./data:/app/data:rw
    ports:
      - "${DAGSTER_PORT:-3000}:3000"
    depends_on:
      neo4j:
        condition: service_healthy
    healthcheck: *healthcheck-dagster
    networks:
      - sbir-network
    restart: ${DAGSTER_RESTART_POLICY:-unless-stopped}

  # =============================================================================
  # Dagster Daemon Service
  # =============================================================================
  dagster-daemon:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    image: ${IMAGE_NAME:-sbir-etl}:${IMAGE_TAG:-local}
    container_name: ${DAGSTER_DAEMON_CONTAINER_NAME:-sbir-dagster-daemon}
    profiles:
      - ci
      - dev
    environment: *common-environment
    volumes:
      # Bind mounts work for both dev (live editing) and CI (ephemeral runner filesystem)
      - ./src:/app/src:rw
      - ./config:/app/config:rw
      - ./.env:/app/.env:ro
      - ./reports:/app/reports:rw
      - ./logs:/app/logs:rw
      - ./data:/app/data:rw
    depends_on:
      neo4j:
        condition: service_healthy
      dagster-webserver:
        condition: service_healthy
    command: ["sh", "/app/scripts/docker/entrypoint.sh", "dagster-daemon"]
    healthcheck: *healthcheck-daemon
    networks:
      - sbir-network
    restart: ${DAGSTER_RESTART_POLICY:-unless-stopped}

  # =============================================================================
  # ETL Runner Service
  # =============================================================================
  etl-runner:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    image: ${IMAGE_NAME:-sbir-etl}:${IMAGE_TAG:-local}
    container_name: ${ETL_RUNNER_CONTAINER_NAME:-sbir-etl-runner}
    profiles:
      - ci
      - dev
    environment: *common-environment
    volumes:
      # Bind mounts work for both dev (live editing) and CI (ephemeral runner filesystem)
      - ./src:/app/src:rw
      - ./config:/app/config:rw
      - ./.env:/app/.env:ro
      - ./reports:/app/reports:rw
      - ./logs:/app/logs:rw
      - ./data:/app/data:rw
      - ./:/app:ro
    entrypoint: ["sh", "/app/scripts/docker/entrypoint.sh", "etl-runner"]
    command:
      - "--"
      - "sh"
      - "-c"
      - "echo 'etl-runner ready; run with docker compose run etl-runner -- <cmd>' && sleep infinity"
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - sbir-network
    restart: "no"

  # =============================================================================
  # CI Test App Service
  # =============================================================================
  app:
    image: sbir-etl:ci-${GITHUB_SHA:-latest}
    container_name: sbir-app-test
    profiles:
      - ci
    env_file:
      - .env
    environment:
      - ENVIRONMENT=test
      - PYTHONPATH=/app
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - SBIR_ETL__NEO4J__BOLT_URL=bolt://neo4j:7687
      - SBIR_ETL__NEO4J__USERNAME=${NEO4J_USER}
      - SBIR_ETL__NEO4J__PASSWORD=${NEO4J_PASSWORD}
      - SBIR_ETL__USPTO__RAW_DIR=/app/data/raw/uspto
      - PYTHONUNBUFFERED=1
      - COVERAGE_FILE=/tmp/.coverage
      - COVERAGE_HTML_DIR=/tmp/htmlcov
      - TEST_TIMEOUT=${TEST_TIMEOUT:-600}
      # E2E test variables (only run if E2E_TEST_SCENARIO is explicitly set)
      - E2E_TEST_SCENARIO=${E2E_TEST_SCENARIO:-}
      - E2E_TEST_TIMEOUT=${E2E_TEST_TIMEOUT:-600}
      - MACBOOK_AIR_MODE=${MACBOOK_AIR_MODE:-true}
      - E2E_TEST_DATA_DIR=/app/test-data
      - E2E_ARTIFACTS_DIR=/app/artifacts
      - E2E_REPORTS_DIR=/app/reports
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - sbir-network
    <<: *resource-limits
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    command: >
      sh -c "
        set -eux;
        echo 'Installing CI test dependencies (pip) inside container';
        pip install --no-cache-dir pandas pyarrow pyreadstat dagster dagit dagster-core || true;
        echo 'Running fast tests inside container';
        pytest -m fast -q;
        echo 'Running Dagster uspto_validation_job runner (in-process)';
        python /app/scripts/ci/run_uspto_job.py;
        if [ -n \"$${E2E_TEST_SCENARIO}\" ] && [ \"$${E2E_TEST_SCENARIO}\" != \"none\" ]; then
          echo 'Running E2E tests...';
          python scripts/e2e_health_check.py;
          python scripts/run_e2e_tests.py --scenario $${E2E_TEST_SCENARIO} --timeout $${E2E_TEST_TIMEOUT:-600};
        fi;
      "
    working_dir: /app
    volumes:
      - ./:/app:ro
      - ./data/raw/uspto:/app/data/raw/uspto:rw
      - ./tests/fixtures:/app/test-data:ro
      - ./src:/app/src:ro
      - ./config:/app/config:ro
    restart: "no"

  # =============================================================================
  # Tools Service
  # =============================================================================
  tools:
    image: python:3.11-slim
    container_name: ${TOOLS_CONTAINER_NAME:-sbir-tools}
    profiles:
      - ci
      - dev
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-dev}
      PYTHONUNBUFFERED: 1
    volumes:
      # Bind mounts work for both dev (live editing) and CI (ephemeral runner filesystem)
      - ./src:/workspace/src:rw
      - ./config:/workspace/config:rw
      - ./.env:/workspace/.env:ro
      - ./data:/workspace/data:rw
      - ./reports:/workspace/reports:rw
      - ./logs:/workspace/logs:rw
      - ./:/workspace:rw
    working_dir: /workspace
    command: ["tail", "-f", "/dev/null"]
    networks:
      - sbir-network
    restart: "no"

# =============================================================================
# Named Volumes
# =============================================================================
volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_import:
    driver: local
  reports:
    driver: local
  logs:
    driver: local
  data:
    driver: local
  config:
    driver: local
  metrics:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  sbir-network:
    name: sbir-network
    driver: bridge
