# sbir-etl/docker/docker-compose.dev.yml
#
# Development Compose profile for SBIR ETL
#
# Usage:
#   docker compose -f docker/docker-compose.dev.yml --profile dev up --build
#
# This file provides a developer-friendly stack:
#  - neo4j (bind-mounts for data/import/logs)
#  - dagster-webserver (bind-mounts src/config for live edit; runs `dagster dev` by default)
#  - dagster-daemon (depends on neo4j + webserver health)
#  - etl-runner (ad-hoc container for running CLI jobs; not started automatically)
#  - tools (lightweight container for interactive debugging; optional)
#
# Environment is read from top-level .env in repository root. Example variables:
#   - NEO4J_AUTH (e.g. "neo4j/password")
#   - NEO4J_HOST / NEO4J_PORT (defaults are used by services)
#   - ENVIRONMENT=dev
#   - SERVICE_STARTUP_TIMEOUT
#
x-common-args: &common-args
  restart: unless-stopped
  env_file:
    - ../.env
  networks:
    - sbir-net

x-healthcheck-curl: &healthcheck-curl
  test: ["CMD-SHELL", "curl -fsS --max-time 3 http://localhost:${HEALTHCHECK_PORT:-3000}${HEALTHCHECK_PATH:-/server_info} || exit 1"]
  interval: 10s
  timeout: 3s
  retries: 5
  start_period: 5s

services:

  neo4j:
    image: neo4j:5.9
    container_name: sbir_neo4j_dev
    <<: *common-args
    environment:
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/test}
      - NEO4J_dbms_logs_debug_level=${NEO4J_LOG_LEVEL:-INFO}
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"
      - "${NEO4J_BOLT_PORT:-7687}:7687"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -u ${NEO4J_USER:-neo4j}:${NEO4J_PASSWORD:-test} http://localhost:7474/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 5s
    # Bind-mount data/logs/import for persistent local development
    volumes:
      - "../data/neo4j:/data"
      - "../data/neo4j/import:/var/lib/neo4j/import"
      - "../logs/neo4j:/logs"
    networks:
      - sbir-net

  dagster-webserver:
    build:
      context: ../
      dockerfile: Dockerfile
      target: runtime
    image: sbir-etl:dev
    container_name: sbir_dagster_web_dev
    <<: *common-args
    environment:
      ENVIRONMENT: "dev"
      SERVICE_STARTUP_TIMEOUT: "${SERVICE_STARTUP_TIMEOUT:-120}"
      SBIR_ETL__NEO4J__HOST: "${NEO4J_HOST:-neo4j}"
      SBIR_ETL__NEO4J__PORT: "${NEO4J_PORT:-7687}"
      NEO4J_USER: "${NEO4J_USER:-neo4j}"
      NEO4J_PASSWORD: "${NEO4J_PASSWORD:-test}"
      # Enable watch/reloader integration for local dev; entrypoint honors this flag
      ENABLE_WATCHFILES: "1"
      # Expose Dagster dev command by default
      ENV_DAGSTER_CMD: "${ENV_DAGSTER_CMD:-dagster dev -h 0.0.0.0 -p 3000}"
      HEALTHCHECK_PORT: "3000"
      HEALTHCHECK_PATH: "/server_info"
    volumes:
      # Bind-mount source and config so edits are visible inside container
      - "../src:/app/src:rw"
      - "../config:/app/config:rw"
      - "../.env:/app/.env:ro"
      - "../reports:/app/reports:rw"
      - "../logs:/app/logs:rw"
      - "../data:/app/data:rw"
    ports:
      - "${DAGSTER_PORT:-3000}:3000"
    depends_on:
      neo4j:
        condition: service_healthy
    healthcheck: *healthcheck-curl

  dagster-daemon:
    build:
      context: ../
      dockerfile: Dockerfile
      target: runtime
    image: sbir-etl:dev
    container_name: sbir_dagster_daemon_dev
    <<: *common-args
    environment:
      ENVIRONMENT: "dev"
      SERVICE_STARTUP_TIMEOUT: "${SERVICE_STARTUP_TIMEOUT:-120}"
      SBIR_ETL__NEO4J__HOST: "${NEO4J_HOST:-neo4j}"
      SBIR_ETL__NEO4J__PORT: "${NEO4J_PORT:-7687}"
      NEO4J_USER: "${NEO4J_USER:-neo4j}"
      NEO4J_PASSWORD: "${NEO4J_PASSWORD:-test}"
    volumes:
      - "../src:/app/src:rw"
      - "../config:/app/config:rw"
      - "../.env:/app/.env:ro"
      - "../reports:/app/reports:rw"
      - "../logs:/app/logs:rw"
    depends_on:
      neo4j:
        condition: service_healthy
      dagster-webserver:
        condition: service_healthy
    command: ["sh", "/app/scripts/docker/entrypoint.sh", "dagster-daemon"]
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q dagster-daemon || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 5s

  # etl-runner is an ad-hoc container for running CLI commands inside the same runtime image.
  # It is not started automatically by default in the dev profile; run with:
  #   docker compose --profile dev -f docker/docker-compose.dev.yml up etl-runner
  etl-runner:
    build:
      context: ../
      dockerfile: Dockerfile
      target: runtime
    image: sbir-etl:dev
    container_name: sbir_etl_runner_dev
    <<: *common-args
    profiles:
      - dev
    environment:
      ENVIRONMENT: "dev"
      SBIR_ETL__NEO4J__HOST: "${NEO4J_HOST:-neo4j}"
      SBIR_ETL__NEO4J__PORT: "${NEO4J_PORT:-7687}"
      NEO4J_USER: "${NEO4J_USER:-neo4j}"
      NEO4J_PASSWORD: "${NEO4J_PASSWORD:-test}"
    volumes:
      - "../src:/app/src:rw"
      - "../config:/app/config:rw"
      - "../.env:/app/.env:ro"
      - "../reports:/app/reports:rw"
      - "../logs:/app/logs:rw"
      - "../data:/app/data:rw"
    entrypoint: ["sh", "/app/scripts/docker/entrypoint.sh", "etl-runner"]
    # By default the runner will wait for Neo4j; provide your command after "--" when launching
    command: ["--", "sh", "-c", "echo 'etl-runner ready; run with docker compose run etl-runner -- <cmd>' && sleep infinity"]

  # Optional lightweight tools container for debugging / interactive REPLs (DuckDB, quick scripts).
  tools:
    image: python:3.11-slim
    container_name: sbir_tools_dev
    profiles:
      - dev
    <<: *common-args
    environment:
      ENVIRONMENT: "dev"
      PYTHONUNBUFFERED: "1"
    volumes:
      - "../src:/workspace/src:rw"
      - "../config:/workspace/config:rw"
      - "../.env:/workspace/.env:ro"
      - "../data:/workspace/data:rw"
      - "../reports:/workspace/reports:rw"
      - "../logs:/workspace/logs:rw"
    working_dir: /workspace
    command: ["tail", "-f", "/dev/null"]

volumes:
  # Named volumes can be used as an alternative to bind mounts if desired.
  neo4j_data: {}
  neo4j_logs: {}
  neo4j_import: {}
  reports: {}
  logs: {}

networks:
  sbir-net:
    name: sbir-dev-network
    driver: bridge

# Notes / recommended commands:
#  - Start the full dev stack (webserver + daemon + neo4j):
#      docker compose -f docker/docker-compose.dev.yml --profile dev up --build
#
#  - Start only webserver and neo4j (faster iteration):
#      docker compose -f docker/docker-compose.dev.yml up --build dagster-webserver neo4j
#
#  - Run an ad-hoc job via etl-runner:
#      docker compose -f docker/docker-compose.dev.yml run --rm etl-runner -- python -m src.scripts.run_my_job --some-arg
#
#  - To get a shell in the running image:
#      docker compose -f docker/docker-compose.dev.yml exec dagster-webserver sh
#
#  - The `ENABLE_WATCHFILES=1` env flag is honored by the entrypoint and will cause
#    the dev entrypoint to use `dagster dev` with a file-watcher / reloader when available.
#
